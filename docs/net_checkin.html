<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Net Check-Ins</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.error-msg { color: #dc3545; } 
.info-msg { color: #198754; }  
.pending-box { background-color: #fff3cd; border: 1px solid #ffeeba; padding:0.5rem; margin-top:0.5rem; } 
th { cursor: pointer; }
#infoBanner { font-size: 0.9rem; margin-top: 0.5rem; }
</style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">Net Check-Ins</span>
    <form class="d-flex ms-3">
      <input type="text" id="netName" class="form-control form-control-sm me-1" placeholder="Net Name">
      <input type="datetime-local" id="netDateTime" class="form-control form-control-sm me-1">
      <input type="text" id="frequencyInput" class="form-control form-control-sm me-1" placeholder="Frequency (MHz)">
      <button id="resetButton" type="button" class="btn btn-secondary btn-sm me-1">Reset List</button>
      <button id="downloadCSV" type="button" class="btn btn-success btn-sm" disabled>Download CSV</button>
    </form>
    <div class="dropdown ms-auto">
      <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="loginDropdown" data-bs-toggle="dropdown" aria-expanded="false">Login</button>
      <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 250px;">
        <li>
          <form id="loginForm">
            <div class="mb-2">
              <input type="text" class="form-control form-control-sm" id="username" placeholder="QRZ Username" autocomplete="username">
            </div>
            <div class="mb-2">
              <input type="password" class="form-control form-control-sm" id="password" placeholder="Password" autocomplete="current-password">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary btn-sm" type="submit">Login</button>
            </div>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Enter Call Sign</h5>
      <div class="input-group">
        <input id="callsignInput" type="text" class="form-control" placeholder="e.g., K1ABC">
        <button id="lookupButton" class="btn btn-primary">Lookup</button>
      </div>
      <div id="status" class="form-text mt-2"></div>
      <div id="lookupResult" class="pending-box" style="display:none;"></div>
      <div id="infoBanner" class="text-muted">
        Tip: <strong>Tab</strong> performs a lookup without adding to the list. <strong>Enter</strong> adds the currently displayed callsign to the check-in list.
      </div>
    </div>
  </div>

  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Checked-In Operators</h5>
      <table class="table table-striped" id="callTable">
        <thead>
          <tr>
            <th data-key="callsign">Call Sign</th>
            <th data-key="name">Name</th>
            <th data-key="location">Location</th>
            <th data-key="time">Check-In Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const hamBands=[[1.8,2],[3.5,4],[7,7.3],[14,14.35],[21,21.45],[28,29.7],[50,54],[144,148],[222,225],[420,450]];
  let sessionKey = null, tempLookupData = null, currentSort = {key:null,asc:true};

  const dtInput = document.getElementById("netDateTime");
  const now = new Date(); now.setMinutes(0,0,0); now.setHours(now.getHours()+1);
  dtInput.value = now.toISOString().slice(0,16);

  const statusEl = document.getElementById("status");
  const lookupResultEl = document.getElementById("lookupResult");
  const callInput = document.getElementById("callsignInput");
  const lookupBtn = document.getElementById("lookupButton");
  const freqInput = document.getElementById("frequencyInput");
  const tbody = document.querySelector("#callTable tbody");
  const downloadBtn = document.getElementById("downloadCSV");
  const netNameInput = document.getElementById("netName");

  // Enable inputs by default
  callInput.disabled = false;
  lookupBtn.disabled = false;
  freqInput.disabled = false;

  // Auto-uppercase input
  callInput.addEventListener("input", e => {
    callInput.value = callInput.value.toUpperCase();
  });

  function showStatus(msg, type="error") {
    if(!msg){ statusEl.style.display="none"; return; }
    statusEl.style.display="block";
    statusEl.textContent = msg;
    statusEl.className = type==="error"?"error-msg":"info-msg";
  }

  function isValidFrequency(freq){
    const f = parseFloat(freq);
    if(isNaN(f)) return false;
    return hamBands.some(b => f>=b[0] && f<=b[1]);
  }

  freqInput.addEventListener("blur", ()=>{
    const freq = freqInput.value.trim();
    if(freq && !isValidFrequency(freq)){
      showStatus("Invalid frequency! Must be a valid ham band in MHz.","error");
    } else {
      showStatus("", "info");
    }
  });

  async function qrzLookupCall(callsign){
    if(!sessionKey) return {callsign: callsign.toUpperCase(), name:"—", location:"—"};
    const url = `https://xmldata.qrz.com/xml/current/?s=${encodeURIComponent(sessionKey)}&callsign=${encodeURIComponent(callsign)}`;
    const resp = await fetch(url);
    const text = await resp.text();
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const errorNode = xml.querySelector("Session > Error");
    if(errorNode) throw new Error(errorNode.textContent.trim());
    const callNode = xml.querySelector("Callsign");
    if(!callNode) throw new Error("Callsign not found");
    const fname = xml.querySelector("fname")?.textContent||"";
    const lname = xml.querySelector("name")?.textContent||"";
    const addr2 = xml.querySelector("addr2")?.textContent||"";
    const country = xml.querySelector("country")?.textContent||"";
    return {callsign: callsign.toUpperCase(), name:(fname+" "+lname).trim()||"—", location:(addr2+", "+country).trim()||"—"};
  }

  async function doLookup() {
    const callsign = callInput.value.trim();
    const freq = freqInput.value.trim();
    if(!callsign){ lookupResultEl.style.display="none"; return; }
    if(freq && !isValidFrequency(freq)){ 
      showStatus("Invalid frequency! Must be a valid ham band.","error"); 
      return; 
    }
    showStatus(`Looking up ${callsign.toUpperCase()}...`, "info");
    try{
      tempLookupData = await qrzLookupCall(callsign);
      tempLookupData.freq = freq;
      lookupResultEl.style.display="block";
      lookupResultEl.textContent = `${tempLookupData.callsign} - ${tempLookupData.name}, ${tempLookupData.location}${freq?` @ ${freq} MHz`:''}`;
      showStatus("", "info");
    } catch(err){ console.error(err); tempLookupData=null; lookupResultEl.style.display="none"; showStatus(`Lookup failed: ${err.message}`, "error"); }
  }

  lookupBtn.addEventListener("click", doLookup);

  callInput.addEventListener("keydown", e=>{
    if(e.key==="Tab"){ e.preventDefault(); doLookup(); }
  });

  callInput.addEventListener("keypress", e=>{
    if(e.key==="Enter" && callInput.value.trim()){
      const data = tempLookupData || {callsign: callInput.value.trim().toUpperCase(), name:"—", location:"—"};
      addCheckinRow(data);
      callInput.value = freqInput.value = "";
      lookupResultEl.style.display="none";
      tempLookupData = null;
    }
  });

  function addCheckinRow(data){
    const row = document.createElement("tr");
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0")+":"+now.getSeconds().toString().padStart(2,"0");
    row.innerHTML = `<td>${data.callsign}</td>
                     <td>${data.name}</td>
                     <td>${data.location}</td>
                     <td>${timeStr}</td>
                     <td><button class="btn btn-sm btn-danger deleteBtn">Delete</button></td>`;
    tbody.appendChild(row);
    row.querySelector(".deleteBtn").addEventListener("click", ()=>row.remove());
  }

  document.getElementById("resetButton").addEventListener("click", ()=>{
    tbody.innerHTML = "";
    lookupResultEl.style.display="none";
    callInput.value = freqInput.value = "";
    updateDownloadState();
  });

  function updateDownloadState(){
    downloadBtn.disabled = !(netNameInput.value.trim() && dtInput.value.trim());
  }

  netNameInput.addEventListener("input", updateDownloadState);
  dtInput.addEventListener("input", updateDownloadState);

  downloadBtn.addEventListener("click", ()=>{
    if(!netNameInput.value.trim() || !dtInput.value.trim()){ alert("Enter Net Name and Date/Time"); return; }
    if(tbody.children.length===0){ alert("No check-ins to download"); return; }
    let csv = "Call Sign,Name,Location,Check-In Time,Net Name,Net DateTime\n";
    Array.from(tbody.children).forEach(r=>{
      const cells = [r.cells[0].textContent,r.cells[1].textContent,r.cells[2].textContent,r.cells[3].textContent];
      csv += cells.map(c=>`"${c.replace(/"/g,'""')}"`).concat([`"${netNameInput.value}"`,`"${dtInput.value}"`]).join(",")+"\n";
    });
    const dt = new Date(dtInput.value);
    const dtStr = dt.getFullYear().toString()+
                  (dt.getMonth()+1).toString().padStart(2,"0")+
                  dt.getDate().toString().padStart(2,"0")+"_"+dt.getHours().toString().padStart(2,"0")+dt.getMinutes().toString().padStart(2,"0");
    const safeName = netNameInput.value.replace(/[^a-z0-9]/gi,"_");
    const filename = `${safeName}_${dtStr}.csv`;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // Table sorting
  document.querySelectorAll("#callTable th[data-key]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.dataset.key;
      const rows = Array.from(tbody.children);
      const asc = (currentSort.key===key)?!currentSort.asc:true;
      currentSort = {key, asc};
      rows.sort((a,b)=>{
        let aVal="",bVal="";
        if(key==="time"){ aVal=a.cells[3].textContent; bVal=b.cells[3].textContent; }
        else if(key==="callsign"){ aVal=a.cells[0].textContent.toUpperCase(); bVal=b.cells[0].textContent.toUpperCase(); }
        else if(key==="name"){ aVal=a.cells[1].textContent.toUpperCase(); bVal=b.cells[1].textContent.toUpperCase(); }
        else if(key==="location"){ aVal=a.cells[2].textContent.toUpperCase(); bVal=b.cells[2].textContent.toUpperCase(); }
        return aVal>bVal? (asc?1:-1) : (aVal<bVal? (asc?-1:1):0);
      });
      rows.forEach(r=>tbody.appendChild(r));
    });
  });

  // Login form
  document.getElementById("loginForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!username || !password) return;
    showStatus("Logging in...", "info");
    try {
      const url=`https://xmldata.qrz.com/xml/current/?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&agent=net_checkins`;
      const resp = await fetch(url);
      const text = await resp.text();
      const keyMatch = text.match(/<Key>(.*?)<\/Key>/);
      if(!keyMatch) throw new Error("Login failed. Check username/password.");
      sessionKey = keyMatch[1];
      showStatus("Login successful","info");

      // Lookup previously entered call signs that were placeholders
      const rows = Array.from(tbody.children);
      for(const row of rows){
        const csCell = row.cells[0].textContent.trim();
        const nameCell = row.cells[1];
        const locCell = row.cells[2];
        if(nameCell.textContent==="—" && locCell.textContent==="—"){
          try {
            const data = await qrzLookupCall(csCell);
            nameCell.textContent = data.name;
            locCell.textContent = data.location;
          } catch(err){ console.error(err); }
        }
      }

    } catch(err){ console.error(err); showStatus(`Login failed: ${err.message}`, "error"); }
  });

});
</script>

<footer class="bg-light text-center text-muted py-2 fixed-bottom border-top">
<small>Copyright &copy; 2025, <a href="https://n2vlv.net" target=_blank>Jeffrey Honig / N2VLV</a> &nbsp; <a href="mailto:n2vlv@honig.net">n2vlv@honig.net</a></small>
</footer>
</body>
</html>
