M<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Net Check-Ins</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
.error-msg { color: #dc3545; } 
.info-msg { color: #198754; }  
.pending-box { background-color: #fff3cd; border: 1px solid #ffeeba; padding:0.5rem; margin-top:0.5rem; } 
th { cursor: pointer; }
#infoBanner { font-size: 0.9rem; margin-top: 0.5rem; }
.traffic-cell { cursor: pointer; }
</style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">Net Check-Ins</span>
    <form class="d-flex ms-3">
      <input type="text" id="netName" class="form-control form-control-sm me-1" placeholder="Net Name">
      <input type="datetime-local" id="netDateTime" class="form-control form-control-sm me-1">
      <input type="text" id="frequencyInput" class="form-control form-control-sm me-1" placeholder="Frequency (MHz)">
      <button id="resetButton" type="button" class="btn btn-secondary btn-sm me-1">Clear all data</button>
      <span id="downloadWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
        <button id="downloadCSV" type="button" class="btn btn-success btn-sm">Download CSV</button>
      </span>
    </form>

    <div class="d-flex ms-auto align-items-center">
      <!-- Help button -->
      <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#helpModal">
        <i class="bi bi-question-circle"></i> Help
      </button>

      <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="loginDropdown" data-bs-toggle="dropdown" aria-expanded="false">QRZ Login</button>
        <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 250px;">
          <li>
            <form id="loginForm">
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" id="username" placeholder="QRZ Username" autocomplete="username" required>
              </div>
              <div class="mb-2">
                <input type="password" class="form-control form-control-sm" id="password" placeholder="Password" autocomplete="current-password" required>
              </div>
              <div class="d-grid">
                <button class="btn btn-primary btn-sm" type="submit">Login</button>
              </div>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Net Check-Ins Help</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>QRZ Login:</strong> Optional. You only need an XML subscription to look up callsigns. Passwords are <em>not</em> stored, only the session key.</p>
        <p><strong>Local Data:</strong> All check-in data is stored locally in your browser (localStorage). Nothing is shared online.</p>
        <p><strong>Input Keys:</strong></p>
        <ul>
          <li><strong>Tab:</strong> Performs a lookup of the callsign without adding it to the list.</li>
          <li><strong>Enter:</strong> Adds the currently displayed callsign to the check-in list with traffic set to <i class="bi bi-circle text-secondary"></i> (<code>-</code>).</li>
          <li><strong>Shift + Enter:</strong> Adds the callsign with traffic set to <i class="bi bi-exclamation-triangle text-warning"></i> (<code>*</code>).</li>
        </ul>
        <p><strong>Traffic Column:</strong> Tri-state values: <i class="bi bi-circle text-secondary"></i> (<code>-</code> = no traffic), <i class="bi bi-exclamation-triangle text-warning"></i> (<code>*</code> = traffic), <i class="bi bi-check-circle text-success"></i> (<code>✔</code> = traffic covered). Click the box to rotate the state.</p>
        <p><strong>GitHub:</strong> To file issues or contribute, visit <a href="https://github.com/your-repo/net-checkins" target="_blank">https://github.com/your-repo/net-checkins</a></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Enter Call Sign</h5>
      <div class="input-group">
        <input id="callsignInput" type="text" class="form-control" placeholder="e.g., K1ABC">
        <button id="lookupButton" class="btn btn-primary">Lookup</button>
      </div>
      <div id="status" class="form-text mt-2"></div>
      <div id="lookupResult" class="pending-box" style="display:none;"></div>
      <div id="infoBanner" class="text-muted">
        Tip: <strong>Tab</strong> performs a lookup without adding to the list. <strong>Enter</strong> adds the currently displayed callsign. Shift+Enter marks traffic.
      </div>
    </div>
  </div>

  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Checked-In Operators</h5>
      <table class="table table-striped" id="callTable">
        <thead>
          <tr>
            <th data-key="callsign">Call Sign</th>
            <th data-key="name">Name</th>
            <th data-key="location">Location</th>
            <th data-key="time">Check-In Time</th>
            <th class="text-center">Traffic</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const hamBands=[[1.8,2],[3.5,4],[7,7.3],[14,14.35],[21,21.45],[28,29.7],[50,54],[144,148],[222,225],[420,450]];
  let sessionKey = null, sessionUser=null, tempLookupData=null, currentSort={key:null,asc:true};

  const dtInput = document.getElementById("netDateTime");
  function setDefaultNetTime(){
    const now = new Date();
    now.setMinutes(0,0,0);
    now.setHours(now.getHours()+1);
    dtInput.value = now.toISOString().slice(0,16);
  }
  setDefaultNetTime();

  const statusEl = document.getElementById("status");
  const lookupResultEl = document.getElementById("lookupResult");
  const callInput = document.getElementById("callsignInput");
  const lookupBtn = document.getElementById("lookupButton");
  const freqInput = document.getElementById("frequencyInput");
  const tbody = document.querySelector("#callTable tbody");
  const downloadBtn = document.getElementById("downloadCSV");
  const downloadWrapper = document.getElementById("downloadWrapper");
  const netNameInput = document.getElementById("netName");
  const loginDropdown = document.getElementById("loginDropdown");

  // Initialize tooltip
  let tooltip = new bootstrap.Tooltip(downloadWrapper);

  function showStatus(msg,type="error"){
    if(!msg){ statusEl.style.display="none"; return; }
    statusEl.style.display="block";
    statusEl.textContent = msg;
    statusEl.className = type==="error"?"error-msg":"info-msg";
  }

  function isValidFrequency(freq){
    const f=parseFloat(freq);
    if(isNaN(f)) return false;
    return hamBands.some(b=>f>=b[0]&&f<=b[1]);
  }

  function setDownloadTooltip(){
    let missing = [];
    if(!netNameInput.value.trim()) missing.push("Net Name");
    if(!dtInput.value.trim()) missing.push("Net Date/Time");
    if(tbody.children.length===0) missing.push("At least one check-in");

    const tooltipText = missing.length ? "Fill in: " + missing.join(", ") : "Download CSV";
    downloadBtn.disabled = missing.length > 0;

    tooltip.dispose();
    downloadWrapper.setAttribute("title", tooltipText);
    tooltip = new bootstrap.Tooltip(downloadWrapper);
  }

  freqInput.addEventListener("blur", ()=>{
    const freq=freqInput.value.trim();
    if(freq && !isValidFrequency(freq)){
      showStatus("Invalid frequency! Must be a valid ham band in MHz.","error");
    } else showStatus("", "info");
  });

  const trafficStates = [
    { icon: "bi-circle text-secondary", value: "-" },
    { icon: "bi-exclamation-triangle text-warning", value: "*" },
    { icon: "bi-check-circle text-success", value: "✔" }
  ];

  function createTrafficCell(initialState = 0) {
    const td = document.createElement("td");
    td.className = "text-center traffic-cell";
    let stateIndex = initialState;

    const i = document.createElement("i");
    i.className = trafficStates[stateIndex].icon;
    td.appendChild(i);

    td.addEventListener("click", () => {
      stateIndex = (stateIndex + 1) % trafficStates.length;
      i.className = trafficStates[stateIndex].icon;
      saveData();
    });

    td.getTrafficValue = () => trafficStates[stateIndex].value;
    td.setTrafficValue = (val) => {
      const idx = trafficStates.findIndex(s => s.value === val);
      if(idx >= 0){
        stateIndex = idx;
        i.className = trafficStates[stateIndex].icon;
      }
    }

    return td;
  }

  function saveData(){
    const data={
      calls:Array.from(tbody.children).map(r=>({
        callsign:r.cells[0].textContent,
        name:r.cells[1].textContent,
        location:r.cells[2].textContent,
        time:r.cells[3].textContent,
        traffic:r.cells[4].getTrafficValue()
      })),
      netName:netNameInput.value,
      netDateTime:dtInput.value,
      freq:freqInput.value
    };
    localStorage.setItem("netCheckData",JSON.stringify(data));
    if(sessionKey && sessionUser){
      localStorage.setItem("qrzSession",JSON.stringify({sessionKey,sessionUser}));
    }
  }

  function loadData(){
    const saved=JSON.parse(localStorage.getItem("netCheckData")||"{}");
    if(saved.calls){
      saved.calls.forEach(c=>{
        const row=document.createElement("tr");
        row.innerHTML=`<td>${c.callsign}</td><td>${c.name}</td><td>${c.location}</td><td>${c.time}</td>`;
        const trafficCell = createTrafficCell();
        trafficCell.setTrafficValue(c.traffic || "-");
        row.appendChild(trafficCell);

        const delTd = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-sm btn-danger deleteBtn";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", ()=>{ row.remove(); saveData(); setDownloadTooltip(); });
        delTd.appendChild(delBtn);
        row.appendChild(delTd);

        tbody.appendChild(row);
      });
    }
    if(saved.netName) netNameInput.value=saved.netName;
    if(saved.netDateTime) dtInput.value=saved.netDateTime;
    if(saved.freq) freqInput.value=saved.freq;
  }

  function updateLoginDisplay(){
    loginDropdown.textContent = sessionUser ? sessionUser.toUpperCase() : "QRZ Login";
  }

  function loadSession(){
      const sess = JSON.parse(localStorage.getItem("qrzSession") || "{}");
      if(sess.sessionKey && sess.sessionUser){
          sessionKey = sess.sessionKey;
          sessionUser = sess.sessionUser;
      }
      updateLoginDisplay();
      callInput.disabled = lookupBtn.disabled = freqInput.disabled = false;
  }

  async function qrzLookupCall(callsign){
      if(!sessionKey) throw new Error("Not logged in");
      const url = `https://xmldata.qrz.com/xml/current/?s=${encodeURIComponent(sessionKey)}&callsign=${encodeURIComponent(callsign)}`;
      const resp = await fetch(url);
      const text = await resp.text();
      const xml = new DOMParser().parseFromString(text, "application/xml");
      if(xml.querySelector("Session > Error")){
          sessionKey = null;
          sessionUser = null;
          localStorage.removeItem("qrzSession");
          updateLoginDisplay();
          throw new Error("QRZ session invalid. Logged out.");
      }
      const fname = xml.querySelector("fname")?.textContent||"";
      const lname = xml.querySelector("name")?.textContent||"";
      const addr2 = xml.querySelector("addr2")?.textContent||"";
      const country = xml.querySelector("country")?.textContent||"";
      return {callsign, name: (fname+" "+lname).trim()||"—", location: (addr2+", "+country).trim()||"—"};
  }

  document.getElementById("loginForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const username=document.getElementById("username").value.trim();
    const password=document.getElementById("password").value.trim();
    if(!username||!password) return;
    showStatus("Logging in...", "info");
    try{
      const url=`https://xmldata.qrz.com/xml/current/?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&agent=net_checkins`;
      const resp=await fetch(url);
      const text=await resp.text();
      const keyMatch=text.match(/<Key>(.*?)<\/Key>/);
      if(!keyMatch) throw new Error("Login failed. Check username/password.");
      sessionKey=keyMatch[1];
      sessionUser=username;
      localStorage.setItem("qrzSession",JSON.stringify({sessionKey,sessionUser}));
      updateLoginDisplay();
      showStatus("Login successful","info");

      for(const r of tbody.children){
        try{
          const data=await qrzLookupCall(r.cells[0].textContent);
          r.cells[1].textContent=data.name;
          r.cells[2].textContent=data.location;
        }catch(err){}
      }
    }catch(err){ console.error(err); showStatus(`Login failed: ${err.message}`, "error"); }
  });

  async function doLookup(){
    const callsign=callInput.value.trim().toUpperCase();
    callInput.value=callsign;
    const freq=freqInput.value.trim();
    if(!callsign){ lookupResultEl.style.display="none"; return; }
    if(freq && !isValidFrequency(freq)){ showStatus("Invalid frequency! Must be a valid ham band.","error"); return; }
    showStatus(`Looking up ${callsign}...`,"info");
    if(sessionKey){
      try{
        tempLookupData=await qrzLookupCall(callsign);
      }catch(err){ tempLookupData={callsign,name:"—",location:"—"}; showStatus(err.message,"error"); }
    } else {
      tempLookupData={callsign,name:"—",location:"—"};
    }
    tempLookupData.freq=freq;
    lookupResultEl.style.display="block";
    lookupResultEl.textContent=`${tempLookupData.callsign} - ${tempLookupData.name}, ${tempLookupData.location}${freq?` @ ${freq} MHz`:''}`;
    showStatus("", "info");
  }

  lookupBtn.addEventListener("click", doLookup);

  callInput.addEventListener("input", ()=>{ callInput.value=callInput.value.toUpperCase(); });
  callInput.addEventListener("keydown", e=>{
    if(e.key==="Tab"){ e.preventDefault(); doLookup(); }
  });

  callInput.addEventListener("keypress", async e=>{
      if(e.key==="Enter" && callInput.value.trim()){
	await doLookup();
	if(tempLookupData){
	  // Check for duplicate
	  const callsignUpper = tempLookupData.callsign.toUpperCase();
	  const duplicate = Array.from(tbody.children).some(r => r.cells[0].textContent.toUpperCase() === callsignUpper);
	  if(duplicate){
	    showStatus(`Duplicate call sign: ${callsignUpper}`, "error");
	    return;
	  }

	  const row=document.createElement("tr");
	  const now=new Date();
	  const timeStr=now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0")+":"+now.getSeconds().toString().padStart(2,"0");

	  row.innerHTML=`<td>${tempLookupData.callsign}</td><td>${tempLookupData.name}</td><td>${tempLookupData.location}</td><td>${timeStr}</td>`;
	  const trafficCell = createTrafficCell(e.shiftKey ? 1 : 0); // Shift+Enter = Pending
	  row.appendChild(trafficCell);

	  const delTd = document.createElement("td");
	  const delBtn = document.createElement("button");
	  delBtn.className = "btn btn-sm btn-danger deleteBtn";
	  delBtn.textContent = "Delete";
	  delBtn.addEventListener("click", () => { row.remove(); saveData(); setDownloadTooltip(); });
	  delTd.appendChild(delBtn);
	  row.appendChild(delTd);

	  tbody.appendChild(row);
	  callInput.value=freqInput.value=""; lookupResultEl.style.display="none"; tempLookupData=null;
	  showStatus("", "info");
	  saveData(); setDownloadTooltip();
	}
      }
  });

  document.getElementById("resetButton").addEventListener("click", ()=>{
    tbody.innerHTML="";
    lookupResultEl.style.display="none";
    callInput.value=freqInput.value=""; netNameInput.value="";
    setDefaultNetTime();
    saveData();
    setDownloadTooltip();
  });

  function updateDownloadState(){ setDownloadTooltip(); saveData(); }

  netNameInput.addEventListener("input", updateDownloadState);
  dtInput.addEventListener("input", updateDownloadState);

  downloadBtn.addEventListener("click", ()=>{
    if(!netNameInput.value.trim() || !dtInput.value.trim()){ alert("Enter Net Name and Date/Time"); return; }
    if(tbody.children.length===0){ alert("No check-ins to download"); return; }
    let csv="Call Sign,Name,Location,Check-In Time,Traffic,Net Name,Net DateTime\n";
    Array.from(tbody.children).forEach(r=>{
      const cells=[r.cells[0].textContent,r.cells[1].textContent,r.cells[2].textContent,r.cells[3].textContent,r.cells[4].getTrafficValue()];
      csv+=cells.map(c=>`"${c.replace(/"/g,'""')}"`).concat([`"${netNameInput.value}"`,`"${dtInput.value}"`]).join(",")+"\n";
    });
    const dt=new Date(dtInput.value);
    const dtStr=dt.getFullYear().toString()+(dt.getMonth()+1).toString().padStart(2,"0")+dt.getDate().toString().padStart(2,"0")+"_"+dt.getHours().toString().padStart(2,"0")+dt.getMinutes().toString().padStart(2,"0");
    const safeName=netNameInput.value.replace(/[^a-z0-9]/gi,"_");
    const filename=`${safeName}_${dtStr}.csv`;
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  document.querySelectorAll("#callTable th[data-key]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key=th.dataset.key;
      const rows=Array.from(tbody.children);
      const asc=(currentSort.key===key)?!currentSort.asc:true;
      currentSort={key,asc};
      rows.sort((a,b)=>{
        let aVal="",bVal="";
        if(key==="time"){ aVal=a.cells[3].textContent; bVal=b.cells[3].textContent; }
        else if(key==="callsign"){ aVal=a.cells[0].textContent.toUpperCase(); bVal=b.cells[0].textContent.toUpperCase(); }
        else if(key==="name"){ aVal=a.cells[1].textContent.toUpperCase(); bVal=b.cells[1].textContent.toUpperCase(); }
        else if(key==="location"){ aVal=a.cells[2].textContent.toUpperCase(); bVal=b.cells[2].textContent.toUpperCase(); }
        return aVal>bVal? (asc?1:-1) : (aVal<bVal? (asc?-1:1):0);
      });
      rows.forEach(r=>tbody.appendChild(r));
    });
  });

  loadData();
  loadSession();
  setDownloadTooltip();
});
</script>

<!-- Help Modal -->

<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="helpModalLabel">Help / Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>QRZ Login:</strong> Optional. You only need an XML subscription to look up callsigns. Passwords are <em>not</em> stored, only the session key.</p>
        <p><strong>Local Data:</strong> All check-in data is stored locally in your browser (localStorage). Nothing is shared online.</p>
        <p><strong>Input Keys:</strong></p>
        <ul>
          <li><strong>Tab:</strong> Performs a lookup of the callsign without adding it to the list.</li>
          <li><strong>Enter:</strong> Adds the currently displayed callsign to the check-in list with traffic set to <code>-</code> (no traffic).</li>
          <li><strong>Shift + Enter:</strong> Adds the callsign to the list with traffic set to <i class="bi bi-exclamation-triangle text-warning"></i> (traffic pending).</li>
        </ul>
        <p><strong>Traffic Column:</strong> Tri-state values: <i class="bi bi-circle text-secondary"></i> (no traffic), <i class="bi bi-exclamation-triangle text-warning"></i> (traffic pending), <i class="bi bi-check-circle text-success"></i> (traffic covered). Click the box to rotate the state.</p>
        <p><strong>GitHub:</strong> To file issues or contribute, visit <a href="https://github.com/jchonig/n2vlv" target="_blank">GitHub</a></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<footer class="bg-light text-center text-muted py-2 fixed-bottom border-top">
<small>Copyright &copy; 2025, <a href="https://n2vlv.net" target=_blank>Jeffrey Honig / N2VLV</a> &nbsp; <a href="mailto:n2vlv@honig.net">n2vlv@honig.net</a></small>
</footer>
</body>
</html>
